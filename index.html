<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Table</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap"
      rel="stylesheet"
    />
    
  </head>

  <body>
    <header>
      <div class="container-fluid">
        <nav class="navbar p-0">
          <a class="logo text-decoration-none" href="/">
            <div class="d-flex gap-3 align-items-center">
              <div class="logo-img">
                <img src="assets/images/quadacts-logo.webp" alt="" />
              </div>
            </div>
          </a>
          <div class="header-action"></div>
        </nav>
      </div>
    </header>
    <div class="form-wrapper">
      <div class="container-fluid">
        <div class="d-flex justify-content-between">
          <form action="">
            <div class="d-flex flex-wrap gap-4">
              <div class="dropdown-container">
                <div class="find-input-wrapper" id="searchWrapper">
                  <span>Find</span>
                  <div class="input-with-clear d-flex flex-grow-1">
                    <input
                      type="text"
                      id="searchInput"
                      placeholder="businesses, category"
                      oninput="filterDropdown(); toggleClearIcon(this, 'searchClearIcon')"
                      autocomplete="off"
                    />
                    <span
                      class="clear-icon d-none"
                      id="searchClearIcon"
                      onclick="clearInput('searchInput', 'searchClearIcon')"
                    >
                      <i class="bi bi-x-circle"></i>
                    </span>
                  </div>
                </div>

                <div class="dropdown-menu" id="dropdownMenu">
                  <div class="dropdown-header" id="popularHeader">
                    Popular Categories
                  </div>
                  <div class="dropdown-body" id="dropdownItems">
                    <div class="dropdown-item" data-value="Roofing Contractors">
                      <i class="bi bi-house"></i> Roofing Contractors
                    </div>
                    <div
                      class="dropdown-item"
                      data-value="Real Estate Consultant"
                    >
                      <i class="bi bi-building"></i> Real Estate Consultant
                    </div>
                    <div class="dropdown-item" data-value="General Contractor">
                      <i class="bi bi-briefcase"></i> General Contractor
                    </div>
                    <div class="dropdown-item" data-value="Used Car Dealers">
                      <i class="bi bi-car-front-fill"></i> Used Car Dealers
                    </div>
                    <div class="dropdown-item" data-value="Heating Contractors">
                      <i class="bi bi-thermometer-half"></i> Heating Contractors
                    </div>
                    <div
                      class="dropdown-item"
                      data-value="Air Conditioning Contractors"
                    >
                      <i class="bi bi-wind"></i> Air Conditioning Contractors
                    </div>
                    <div class="dropdown-item" data-value="Auto Repairs">
                      <i class="bi bi-tools"></i> Auto Repairs
                    </div>
                    <div class="dropdown-item" data-value="Financial Services">
                      <i class="bi bi-cash-stack"></i> Financial Services
                    </div>
                    <div class="dropdown-item" data-value="Tree Services">
                      <i class="bi bi-tree-fill"></i> Tree Services
                    </div>
                  </div>
                  <div class="no-results d-none" id="noResults">
                    No results found
                  </div>
                </div>
                <div id="findError" class="text-danger small d-none">
                  Please select the category
                </div>
              </div>

              <div class="dropdown-container d-flex">
                <div
                  class="find-input-wrapper flex-grow-1"
                  id="nearDropdownWrapper"
                >
                  <span>Near</span>
                  <div class="input-with-clear d-flex flex-grow-1">
                    <input
                      type="text"
                      id="nearInput"
                      placeholder="city,state or zip"
                      oninput="filterNearDropdown(); toggleClearIcon(this, 'nearClearIcon')"
                      autocomplete="off"
                    />
                    <span
                      class="clear-icon d-none"
                      id="nearClearIcon"
                      onclick="clearInput('nearInput', 'nearClearIcon')"
                    >
                      <i class="bi bi-x-circle"></i>
                    </span>
                  </div>
                </div>

                <div
                  class="dropdown-menu rounded-0 border border-light"
                  id="nearDropdownMenu"
                >
                  <div class="dropdown-body" id="nearDropdownItems"></div>
                  <div class="no-results d-none" id="nearNoResults">
                    No results found
                  </div>
                </div>

                <div class="custom-select" onclick="toggleDropdown()">
                  <img class="selected-flag" src="" />
                  <span id="selectedText"></span
                  ><i class="bi bi-chevron-down"></i>

                  <ul
                    class="options list-unstyled"
                    id="options"
                    style="display: none"
                  >
                    <li onclick="selectCountry('USA', event)">
                      <img
                        class="country-img"
                        src="https://m.bbb.org/terminuscontent/dist/img/header/flag-us-100__100w.png"
                        alt=""
                      />

                      United States
                    </li>
                    <li onclick="selectCountry('CAN',event )">
                      <img
                        class="country-img"
                        src="https://m.bbb.org/terminuscontent/dist/img/header/flag-ca-100__100w.png"
                        alt=""
                      />
                      Canada
                    </li>
                  </ul>
                </div>
              </div>

              <button class="btn custom-btn">Search</button>
            </div>
          </form>
          <div>
            <button
              class="btn custom-btn d-none"
              id="scrape-inprogress"
              disabled
              style="display: none"
            >
              Scrape Inprogress...
            </button>
            <button
              class="btn custom-btn export d-none"
              id="start-scraping"
              disabled
              style="display: none"
            >
              Scrape again
            </button>
            <button class="btn custom-btn export" id="exportBtn">
              Export to Excel <i class="bi bi-file-earmark-arrow-up"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid table-wrapper">
      <div class="table-responsive">
        <table class="table custom-table table-bordered">
          <thead>
            <tr>
              <th scope="col"><input type="checkbox" id="selectAll" /></th>
              <th scope="col">Business Name</th>
              <th scope="col">Category</th>
              <th scope="col">Main Number</th>
              <th scope="col">Cell Phone</th>
              <th scope="col">Owner Name</th>
              <th scope="col">Manager Name</th>
              <th scope="col">Business Categories</th>
              <th scope="col">Website</th>
              <th scope="col">Email Address</th>
              <th scope="col">Country</th>
              <th scope="col">State Province</th>
              <th scope="col">City</th>
              <th scope="col">Address</th>
              <th scope="col">Postal Code</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="businessTableBody">
            <tr>
              <td scope="col"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-end" id="pagination"></ul>
      </nav>
    </div>
    <div class="container-fluid">
      <div class="show-data"></div>
      <div class="loader d-none">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
          <circle
            fill="#0E72AB"
            stroke="#0E72AB"
            stroke-width="15"
            r="15"
            cx="40"
            cy="65"
          >
            <animate
              attributeName="cy"
              calcMode="spline"
              dur="2"
              values="65;135;65;"
              keySplines=".5 0 .5 1;.5 0 .5 1"
              repeatCount="indefinite"
              begin="-.4"
            ></animate>
          </circle>
          <circle
            fill="#0E72AB"
            stroke="#0E72AB"
            stroke-width="15"
            r="15"
            cx="100"
            cy="65"
          >
            <animate
              attributeName="cy"
              calcMode="spline"
              dur="2"
              values="65;135;65;"
              keySplines=".5 0 .5 1;.5 0 .5 1"
              repeatCount="indefinite"
              begin="-.2"
            ></animate>
          </circle>
          <circle
            fill="#0E72AB"
            stroke="#0E72AB"
            stroke-width="15"
            r="15"
            cx="160"
            cy="65"
          >
            <animate
              attributeName="cy"
              calcMode="spline"
              dur="2"
              values="65;135;65;"
              keySplines=".5 0 .5 1;.5 0 .5 1"
              repeatCount="indefinite"
              begin="0"
            ></animate>
          </circle>
        </svg>
      </div>
    </div>
    <!-- Modal -->
    <div
      class="modal fade"
      id="businessInfoModal"
      tabindex="-1"
      aria-labelledby="businessInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="businessInfoModalLabel">
              Business Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <ul>
                  <li class="fw-semibold">
                    Business Name: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Business Category: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Business Number: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Business Celllihone: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Owner Name: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Manager Name: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Business Categories: <span class="fw-normal"></span>
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul>
                  <li class="fw-semibold">
                    Website: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Email Address: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Country : <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    State Province: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    City: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    Address: <span class="fw-normal"></span>
                  </li>
                  <li class="fw-semibold">
                    postal Code: <span class="fw-normal"></span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"
  ></script>
  <script>
     let businessInfoModal = document.querySelector("#businessInfoModal");
    let selectedCategory = "";
    let selectedNearVal = "";
    let selectedCountryText = "";

    // config.js or directly in your script
    const API_BASE_URL =
      window.location.hostname === "127.0.0.1"
        ? "http://localhost:3000"
        : "http://localhost:3000";

    const recordsPerPage = 10;
    let currentPage = 1;
    let businesses = [];
    let currentData = []; // üëà this is the active dataset

    function parseLocation(raw = "") {
      raw = raw.trim();
      if (!raw) return { street: "", city: "", state: "", zip: "" };
      const parts = raw.split(",").map((p) => p.trim());

      let street = "",
        city = "",
        state = "",
        zip = "";

      if (parts.length >= 3) {
        const stateZip = parts[parts.length - 1].split(/\s+/);
        state = stateZip[0] || "";
        zip = stateZip.slice(1).join(" ") || "";
        city = parts[parts.length - 2] || "";
        street = parts.slice(0, parts.length - 2).join(", ");
      } else if (parts.length === 2) {
        city = parts[0];
        const stateZip = parts[1].split(/\s+/);
        state = stateZip[0] || "";
        zip = stateZip.slice(1).join(" ") || "";
      } else if (parts.length === 1) {
        const tokens = parts[0].split(/\s+/);
        if (tokens.length >= 3) {
          zip = tokens.pop();
          state = tokens.pop();
          city = tokens.join(" ");
        } else {
          city = parts[0];
        }
      }

      return { street, city, state, zip };
    }

    function renderTablePage(page = 1) {
      const tbody = document.getElementById("businessTableBody");
      tbody.innerHTML = "";

      const start = (page - 1) * recordsPerPage;
      const end = start + recordsPerPage;
      const pageData = currentData.slice(start, end);

      if (pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12">No data found.</td></tr>`;
        return;
      }

      pageData.forEach((item) => {
        const locationString = item.location;
        const { street, city, state, zip } = parseLocation(locationString);

        const extras = [
          item.phone2,
          item.phone3,
          item.phone4,
          item.phone5,
          item.phone6,
        ]
          .filter(Boolean)
          .join(", ");
        const tr = document.createElement("tr");
        tr.classList.add("cursor-pointer");
        tr.addEventListener("click", () => {
          const modal = new bootstrap.Modal(businessInfoModal, {
            backdrop: true,
            keyborad: true,
          });
          modal.show();

          const fieldMap = [
            () => item.name,
            () => item.category,
            () => item.phone1,
            () => extras,
            () => item["Owner"] || item["Business Management"] || "",
            () => item["Manager"] || item["Principal Contacts"] || "",
            () => item.related_Categories || "",
            () => item.website || "",
            () => item.email || "",
            () => item.country || "",
            () => item.state || "",
            () => item.city || "",
            () => item.location || "",
            () => item.zip || "",
          ];

          const listItems = document.querySelectorAll(
            "#businessInfoModal ul li"
          );
          listItems.forEach((li, i) => {
            if (fieldMap[i]) {
              li.lastElementChild.textContent = fieldMap[i]();
            }
          });
        });

        console.log("item", item);
        tr.innerHTML = `
      <td><input type="checkbox" class="rowCheckbox" /></td>
      <td>${item.name || ""}</td>
      <td>${item.category || ""}</td>
      <td>${item.phone1 || ""}</td>
      <td style="overflow: visible;
    white-space: normal;">${extras}</td>
      <td>${item["Owner"] || item["Business Management"] || ""}</td>
      <td>${item["Manager"] || item["Principal Contacts"] || ""}</td>
      <td>${item.related_Categories || ""}</td>
      <td>${item.website || ""}</td>
      <td>${item.email || ""}</td>
      <td>${item.country || "USA"}</td>
      <td>${state}</td>
      <td>${city}</td>
      <td>${item.location}</td>
      <td>${zip}</td>
      <td>
        <select class="form-select" aria-label="Default select example">
  <option selected>Select Status</option>
  <option value="1">Call</option>
  <option value="2">Email</option>
</select>
        </td>
    `;
        tbody.appendChild(tr);
      });

      renderPagination();
      setupSelectAllCheckbox();
    }

    function renderPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const totalPages = Math.ceil(currentData.length / recordsPerPage);

      // üîë Hide pagination if only 1 page or no results
      if (totalPages <= 1) {
        pagination.style.display = "none";
        return;
      } else {
        pagination.style.display = "flex"; // show when needed
      }

      const prevLi = document.createElement("li");
      prevLi.className = "page-item" + (currentPage === 1 ? " disabled" : "");
      prevLi.innerHTML = `<a class="page-link" href="#">Prev</a>`;
      prevLi.onclick = (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          renderTablePage(currentPage);
        }
      };
      pagination.appendChild(prevLi);

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      if (currentPage <= 3) {
        endPage = Math.min(5, totalPages);
      }
      if (currentPage > totalPages - 3) {
        startPage = Math.max(1, totalPages - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement("li");
        li.className = "page-item" + (i === currentPage ? " active" : "");
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => {
          e.preventDefault();
          currentPage = i;
          renderTablePage(currentPage);
        };
        pagination.appendChild(li);
      }

      const nextLi = document.createElement("li");
      nextLi.className =
        "page-item" + (currentPage === totalPages ? " disabled" : "");
      nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
      nextLi.onclick = (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          renderTablePage(currentPage);
        }
      };
      pagination.appendChild(nextLi);
    }

    function setupSelectAllCheckbox() {
      const selectAll = document.getElementById("selectAll");
      const checkboxes = document.querySelectorAll(".rowCheckbox");

      selectAll.checked = false;

      selectAll.addEventListener("change", function () {
        checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
      });

      checkboxes.forEach((cb) => {
        cb.addEventListener("change", () => {
          if (!cb.checked) {
            selectAll.checked = false;
          } else if ([...checkboxes].every((c) => c.checked)) {
            selectAll.checked = true;
          }
        });
      });
    }
    const handleScrappeButton = () => {
      if (window.settings) {
        if (settings.scrapper_running) {
          let scrapeBtn = document.querySelector("#start-scraping");
          scrapeBtn.classList.add("d-none");
          const scrapeInprogress = document.querySelector("#scrape-inprogress");
          scrapeInprogress.classList.remove("d-none");
        }
      }
    };
    let originalBusinesses = [];
    async function loadBusinesses(search = "", near = "", country = "") {
      const loader = document.querySelector(".loader");
      loader.classList.remove("d-none");
      try {
        const res = await fetch(
          `${API_BASE_URL}/api/businesses?q=${search}&near=${near}&country=${country}`
        );

        const response = await res.json();

        document.querySelector(".show-data").innerHTML = `<p>showing <b>${
          response.results.length
        }</b> results for<b> ${
          selectedCategory ? selectedCategory : "all categories"
        }</b></p>`;

        window.settings = response.settings;
        handleScrappeButton();

        businesses = response.results || [];
        originalBusinesses = [...businesses];
        currentData = [...businesses];
        currentPage = 1;

        if (!Array.isArray(businesses) || businesses.length === 0) {
          document.getElementById(
            "businessTableBody"
          ).innerHTML = `<tr><td colspan="12">No data found.</td></tr>`;

          // ‚ùó still rebuild pagination ‚Üí no pages if 0
          renderPagination();
          return;
        }

        renderTablePage(currentPage); // this will also call renderPagination()
      } catch (err) {
        document.getElementById(
          "businessTableBody"
        ).innerHTML = `<tr><td colspan="12">Error loading data</td></tr>`;
        console.error("Failed to load data:", err);

        // clear pagination on error
        document.getElementById("pagination").innerHTML = "";
      } finally {
        loader.classList.add("d-none");
      }
    }

    window.onload = loadBusinesses;
  </script>
  <script>
    document.getElementById("exportBtn").addEventListener("click", function () {
      const headers = [
        "Business Name",
        "Category",
        "Main Number",
        "Cell Phone",
        "Owner Name",
        "Manager Name",
        "Website",
        "Email Address",
        "Country",
        "State Province",
        "City",
        "Address",
        "Postal Code",
      ];

      const selectAll = document.getElementById("selectAll");
      const checkboxes = document.querySelectorAll(".rowCheckbox");
      const anyChecked = [...checkboxes].some((cb) => cb.checked);

      let exportData = [];

      if (anyChecked || selectAll.checked) {
        document.querySelectorAll("#businessTableBody tr").forEach((row) => {
          const checkbox = row.querySelector(".rowCheckbox");
          if (checkbox && checkbox.checked) {
            const cells = row.querySelectorAll("td");
            if (cells.length === 13) {
              const rowData = [];
              for (let i = 1; i < cells.length; i++) {
                rowData.push(cells[i].innerText.trim());
              }
              exportData.push(rowData);
            }
          }
        });
      } else {
        exportData = businesses.map((item) => {
          const { street, city, state, zip } = parseLocation(
            item.location || ""
          );
          return [
            item.name || "",
            item.category || "",
            item.phone1 || "",
            [item.phone2, item.phone3, item.phone4, item.phone5, item.phone6]
              .filter(Boolean)
              .join(", ") || "",
            item["Owner"] || item["Business Management"] || "",
            item["Manager"] || item["Principal Contacts"] || "",
            item.website || "",
            item.email || "",
            item.country || "USA",
            state,
            city,
            item.location || "",
            zip,
          ];
        });
      }

      if (exportData.length === 0) {
        alert("No data to export.");
        return;
      }

      const worksheet = XLSX.utils.aoa_to_sheet([headers, ...exportData]);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Businesses");
      XLSX.writeFile(workbook, "businesses_export.xlsx");
    });
  </script>
  <script>
    document
      .querySelector(".custom-btn")
      .addEventListener("click", function (e) {
        e.preventDefault();

        const findValue = document.getElementById("searchInput").value.trim();
        const nearValue = document.getElementById("nearInput").value.trim();
        const selectedCountry = document
          .getElementById("selectedText")
          .innerText.trim();

        selectedCategory = findValue;
        loadBusinesses(findValue, nearValue, selectedCountry);
        if (!findValue) {
          selectedCategory = "";
        }
      });

    function renderFilteredData(data) {
      const tbody = document.getElementById("businessTableBody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12">No data found.</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      businesses = data;
      renderTablePage(currentPage);
    }
  </script>

  <script>
    const searchInput = document.getElementById("searchInput");
    const dropdown = document.getElementById("dropdownMenu");
    const categoryItems = document.querySelectorAll(
      "#dropdownItems .dropdown-item"
    );
    const noResults = document.getElementById("noResults");
    const countryDropdown = document.getElementById("countrySelect");
    const countryImages = document.querySelectorAll(".country-img");

    const nearInput = document.getElementById("nearInput");
    const nearDropdown = document.getElementById("nearDropdownMenu");
    const nearItems = document.querySelectorAll(
      "#nearDropdownItems .dropdown-item"
    );
    const nearNoResults = document.getElementById("nearNoResults");

    searchInput.addEventListener("focus", () => {
      dropdown.classList.add("active");
      filterDropdown();
    });

    async function fetchTableData(suggestion) {
      try {
        const params = new URLSearchParams();

        if (suggestion.type === "Category") {
          params.append("category", suggestion.title);
        } else if (suggestion.type === "Organization") {
          params.append("organization", suggestion.title);
        }

        const res = await fetch(
          `${API_BASE_URL}/api/getRecords?${params.toString()}`
        );
        const data = await res.json();

        populateTable(data);
      } catch (err) {
        console.error("Error fetching table data:", err);
      }
    }

    function populateTable(data) {
      const tbody = document.querySelector("#businessTableBody");
      tbody.innerHTML = ""; // Clear existing rows

      data.forEach((item) => {
        const extras = [
          item.phone2,
          item.phone3,
          item.phone4,
          item.phone5,
          item.phone6,
        ]
          .filter(Boolean)
          .join(", ");
        const row = document.createElement("tr");

        row.innerHTML = `
            <td><input type="checkbox" /></td>
            <td>${item.name || ""}</td>
            <td>${item.category || ""}</td>
            <td>${item.phone1 || ""}</td>
            <td style="overflow: visible;
    white-space: normal;">${extras}</td>
    <td>${item["Owner"] || item["Business Management"] || ""}</td>
      <td>${item["Manager"] || item["Principal Contacts"] || ""}</td>
            <td>${item.related_Categories || ""}</td>
            <td><a href="${item.website || "#"}" target="_blank">${
          item.website || ""
        }</a></td>
            <td>${item.email || ""}</td>
      <td>${item.country || "USA"}</td>
      <td>${item.state}</td>
      <td>${item.city}</td>
      <td>${item.location}</td>
      <td>${item.zip}</td>



          
        `;

        tbody.appendChild(row);
      });
    }

    // Store a permanent reference to your original category items
    const originalCategoryItems = Array.from(categoryItems);

    // Filter function
    async function filterDropdown() {
      const value = searchInput.value.toLowerCase();
      const country =
        document.getElementById("selectedText").innerText || "USA";
      const locationInput = nearInput.value.trim();
      const dropdownBody = document.getElementById("dropdownItems");
      const popularHeader = document.getElementById("popularHeader");

      dropdownBody.innerHTML = ""; // Clear current items
      if (!value) {
        if (popularHeader) popularHeader.style.display = "block";

        // If input is empty, show default popular categories
        originalCategoryItems.forEach((item) => {
          item.style.display = "flex"; // make sure visible
          dropdownBody.appendChild(item);
        });
        noResults.classList.add("d-none");
        return;
      }
      // Hide Popular Categories when typing
      if (popularHeader) popularHeader.style.display = "none";
      try {
        const defaultEntityTypes = ["Category", "Organization"];
        const params = new URLSearchParams();
        params.append("country", country);
        defaultEntityTypes.forEach((type) =>
          params.append("entityTypes", type)
        );
        params.append("input", value);
        params.append("locationInput", locationInput);

        const res = await fetch(
          `${API_BASE_URL}/api/suggest?${params.toString()}`
        );
        const data = await res.json();

        if (!data?.suggestions || data.suggestions.length === 0) {
          noResults.classList.remove("d-none");
          return;
        }

        noResults.classList.add("d-none");

        const categories = data.suggestions.filter(
          (s) => s.type === "Category"
        );
        const organizations = data.suggestions.filter(
          (s) => s.type === "Organization"
        );

        function appendGroup(headerText, items) {
          if (items.length === 0) return;

          const headerDiv = document.createElement("div");
          headerDiv.className = "dropdown-header";
          headerDiv.innerText = headerText;
          dropdownBody.appendChild(headerDiv);

          items.forEach((suggestion) => {
            const regex = new RegExp(`(${searchInput.value.trim()})`, "gi");
            const highlightedText = suggestion.title.replace(
              regex,
              "<strong>$1</strong>"
            );

            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #ccc";
            div.className = "dropdown-item";
            div.innerHTML = `<i class="bi bi-briefcase"></i> ${highlightedText}<p style="margin-bottom:0">${
              suggestion.secondaryTitle || ""
            }</p>`;

            div.addEventListener("click", () => {
              handleSuggestionClick(suggestion);
            });

            dropdownBody.appendChild(div);
          });
        }

        appendGroup("Categories", categories);
        appendGroup("Organizations", organizations);
      } catch (error) {
        console.error("Error fetching suggestions:", error);
      }
    }

    async function handleSuggestionClick(suggestion) {
      // Set input value
      searchInput.value = suggestion.title;
      dropdown.classList.remove("active");
      toggleClearIcon(searchInput, "searchClearIcon");

      selectedCategory = searchInput.value;
      return;
      currentData = originalBusinesses.filter(
        (biz) =>
          (biz.category && biz.category.includes(suggestion.title)) ||
          (biz.name && biz.name.includes(suggestion.title))
      );

      currentPage = 1;
      renderTablePage(currentPage);
      renderPagination();

      try {
        const loader = document.querySelector(".loader");
        loader.classList.remove("d-none");

        let apiUrl = "";
        if (suggestion.type === "Category") {
          apiUrl = `${API_BASE_URL}/api/getRecordsByCategory?category=${encodeURIComponent(
            suggestion.title
          )}`;
        } else if (suggestion.type === "Organization") {
          apiUrl = `${API_BASE_URL}/api/getRecordsByOrganization?organization=${encodeURIComponent(
            suggestion.title
          )}`;
        } else {
          console.warn("Unknown suggestion type:", suggestion.type);
          loader.classList.add("d-none");
          return;
        }

        const res = await fetch(apiUrl);
        const data = await res.json();

        // Clear table and render new data
        populateTable(data); // or use renderTablePage if you need pagination
      } catch (err) {
        console.error("Failed to fetch records:", err);
      } finally {
        document.querySelector(".loader").classList.add("d-none");
      }
    }

    categoryItems.forEach((item) => {
      item.addEventListener("click", () => {
        searchInput.value = item.getAttribute("data-value");
        dropdown.classList.remove("active");
        toggleClearIcon(searchInput, "searchClearIcon");
        searchInput.dispatchEvent(new Event("input", { bubbles: true }));
        selectedCategory = searchInput.value;
      });
    });
    document.addEventListener("click", (e) => {
      const wrapper = document.getElementById("searchWrapper");
      if (!wrapper.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove("active");
      }
    });

    function toggleDropdown() {
      const options = document.getElementById("options");
      options.style.display =
        options.style.display === "none" ? "block" : "none";
    }

    function selectCountry(code, event) {
      document.getElementById("selectedText").innerText = code;
      document.querySelector(".selected-flag").src =
        event.target.firstElementChild.src;

      selectedCountryText = document.getElementById("selectedText").innerText;

      filterNearDropdown();
    }

    nearInput.addEventListener("focus", () => {
      nearDropdown.classList.add("active");
      filterNearDropdown();
    });

    async function filterNearDropdown() {
      const value = nearInput.value.toLowerCase().trim();
      const nearDropdownItemsContainer =
        document.getElementById("nearDropdownItems");
      nearDropdownItemsContainer.innerHTML = "";
      if (!value) {
        document.getElementById("nearNoResults").classList.add("d-none");
        return;
      }
      const nears = await loadNears();
      if (nears.length === 0) {
        document.getElementById("nearNoResults").classList.remove("d-none");
        return;
      }

      document.getElementById("nearNoResults").classList.add("d-none");

      nears.forEach((match) => {
        const div = document.createElement("div");
        div.className = "dropdown-item";
        div.setAttribute("data-value", match);
        div.innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${match}`;
        div.addEventListener("click", () => {
          let parts = match.split(",").map((s) => s.trim());
          if (parts.length === 2) {
            // Swap if first part is state code
            if (/^[A-Z]{2}$/.test(parts[0])) {
              [parts[0], parts[1]] = [parts[1], parts[0]];
            }
            nearInput.value = parts.join(", "); // Now "Los Angeles, CA"
          } else {
            nearInput.value = match;
          }

          selectedNearVal = nearInput.value;
          document
            .getElementById("nearDropdownMenu")
            .classList.remove("active");
          toggleClearIcon(nearInput, "nearClearIcon");
        });
        nearDropdownItemsContainer.appendChild(div);
      });
    }

    async function loadNears() {
      try {
        const country = document
          .getElementById("selectedText")
          .innerText.trim();
        const nearValue = document.getElementById("nearInput").value.trim();
        const res = await fetch(
          `${API_BASE_URL}/api/nears?country=` + country + "&q=" + nearValue
        );
        nears = await res.json();
        return nears;
      } catch (err) {
        console.log("Error fetching nears: ", err);
        return [];
      }
    }

    nearItems.forEach((item) => {
      item.addEventListener("click", () => {
        nearInput.value = item.getAttribute("data-value");
        nearDropdown.classList.remove("active");
        toggleClearIcon(nearInput, "nearClearIcon");
      });
    });

    document.addEventListener("click", (e) => {
      const wrapper = nearInput.parentElement;
      if (!wrapper.contains(e.target) && !nearDropdown.contains(e.target)) {
        nearDropdown.classList.remove("active");
      }
    });
    function toggleClearIcon(inputElem, iconId) {
      const icon = document.getElementById(iconId);
      if (inputElem.value.trim() !== "") {
        icon.classList.remove("d-none");
      } else {
        icon.classList.add("d-none");
      }
    }
    function clearInput(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);

      input.value = "";
      icon.classList.add("d-none");

      if (inputId === "searchInput") {
        const dropdownBody = document.getElementById("dropdownItems");
        dropdownBody.innerHTML = ""; // Clear suggestions
        noResults.classList.add("d-none"); // Hide no results
        filterDropdown(); // Show default popular categories if needed
      }

      if (inputId === "nearInput") {
        const nearDropdownBody = document.getElementById("nearDropdownItems");
        nearDropdownBody.innerHTML = "";
        nearNoResults.classList.add("d-none");
        filterNearDropdown(); // Re-run near suggestions if needed
      }

      input.focus();
    }

    let scrapeBtn = document.querySelector("#start-scraping");
    if (scrapeBtn) {
      scrapeBtn.addEventListener("click", async (e) => {
        await runScrapper();
      });
    }

    const runScrapper = async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/run-scrapper`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        let scrapeBtn = document.querySelector("#start-scraping");
        scrapeBtn.classList.add("d-none");
        const scrapeInprogress = document.querySelector("#scrape-inprogress");
        //scrapeInprogress.classList.remove("d-none");
        console.log("scrapper is running");
      } catch (error) {
        console.log("Error activating scrapper: ", error);
      }
    };
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("selectedText").innerText = "USA";
      document.querySelector(".selected-flag").src =
        "https://m.bbb.org/terminuscontent/dist/img/header/flag-us-100__100w.png";
      selectedCountryText = "USA";
    });
  </script>
</html>
